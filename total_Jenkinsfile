def sailfishNodeA(String c) {   //check-3 in Node-1
	node ('Sailfish1'){ 			//Assigning the Node
		echo 'check-3 in Node-1'
		int conta_Num = sh(returnStdout: true, script: 'docker ps -a| grep alpine | wc -l')
		if (conta_Num == 0) {	
		echo "no.of containers in Sailfish1 " + conta_Num		
		cleanWs()        				
		deletingContainer ('Checking existence')   //Deleting the Conta if existed
		allStages('all the stages') 			      // calling the all stages 	
		}else {
				sailfishNodeC('Calling Master')		
			 }
			}
		} 
def sailfishNodeC(String f) {   //check-4 in Node-2
	node ('Sailfish2') {
		echo 'check-4 in Node-2'
		sleep 35	
		int conta_Num = sh(returnStdout: true, script: 'docker ps -a| grep alpine | wc -l')
		if (conta_Num == 0) {  
		echo "no.of containers in Sailfish1 " + conta_Num
		cleanWs()
		deletingContainer ('Checking existence')  		 //Deleting the Conta if existed
		allStages('all the stages') 		
			
		}else {
		error 'no Node is free to run the job'
		}
	}
}	
def allStages(String a) { //all the stages 
      stage ('Spinnig Conta') {
	 deletingContainer ('Checking existence')
	 sh 'docker run -d --name qe1instance alpine'
      }
       stage ('Pull by commit') {
           sh 'docker ps -a'
       }
       stage ('Atc') {
           sh 'docker ps'
       }
       stage ('Security') {
           sh '''
           docker ps -a | grep 'alpine' | wc -l
           sleep 30
           '''
       }
        stage ('Security') {
           sh 'docker ps -a | grep seconds | wc -l'
       }
       stage ('Deleting Conta') {
           sh 'docker rm -f  qe1instance'
       }  
    }

def deletingContainer (String b) { 		//Container deleting function
   sh '''
   x=$(docker ps -aq --filter "name=qe1instance" | grep -q .  && echo Found || echo Not Found)
  if [ $x=Found ]; 
  then 
     docker rm -f qe1instance
     sleep 15 
  else 
    echo 'container is not created' 
  fi
    '''
}
timestamps {

  node () {	
	stage ('checking for Condition') { 

	node ('Sailfish1') {
	echo 'check-1 in Node-1'
	 int conta_Num = sh(returnStdout: true, script: 'docker ps -a| grep alpine | wc -l')	
	 if (conta_Num == 0) {   		//check-1 in Node-1
		echo 'check-1 in Node-1'
		echo "no.of containers in Sailfish1 " + conta_Num
		deletingContainer ('Checking existence')
		echo 'starting the stages in Sailfish1, As no conta is spinned up'
		allStages('Calling allStages')
		} else { 
		echo 'getting in to Sailfish2 as there were some Contas are running in Sailfish1'	
		sailfishNodeB('Calling theSail')
			      }       
		      }
               }
        }
}
	def sailfishNodeB(String e) {  //check-2 in Node-2
		node ('Sailfish2'){  						// Master=Sailfish2
			echo 'check-2 in Node-2'
			int conta_Num = sh(returnStdout: true, script: 'docker ps -a| grep alpine | wc -l')
		if (conta_Num == 0) {  
			echo "no.of containers in Sailfish1 " + conta_Num
			cleanWs()
			deletingContainer ('Checking existence')  	       //Deleting the Conta if existed
			allStages('all the stages') 			      // calling the all stages 
		 }else {
			 sleep 60                                   		 //waiting time is 3 minutes
			 echo 'getting in to Sailfish1 as there were some Contas are running in Sailfish2'	
			 sailfishNodeA('Calling theSail')
		    }
		 
	      }
	
	}
